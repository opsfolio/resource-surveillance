# Osquery
{ "osqueryMfaEnabled": "osqueryi \"SELECT  node, value, label, path FROM augeas WHERE path='/etc/pam.d/sshd' AND value like '%pam_google_authenticator.so%'\" --json", "nature": "json" }
{ "osqueryDenyRootLogin": "osqueryi \"SELECT node, value, label, path FROM augeas WHERE path='/etc/ssh/sshd_config' AND label like 'PermitRootLogin' AND value like 'no'\" --json", "nature": "json" }
{"osqueryRemovedUserAccounts": "osqueryi \"SELECT * FROM users WHERE shell = 'disabled'\" --json", "nature": "json" }
{ "osqueryEncryptedPasswords": "osqueryi \"SELECT md5, sha1, sha256 from hash where path = '/etc/passwd'\" --json", "nature": "json" }
{ "osquerySshdProcess": "osqueryi \"SELECT name, cmdline, path FROM processes WHERE name = 'sshd'\" --json", "nature": "json" }
{ "osqueryAntivirusStatus": "osqueryi \"SELECT score FROM (SELECT case when COUNT(*) = 2 then 1 ELSE 0 END AS score FROM processes WHERE (name = 'clamd') OR (name = 'freshclam')) WHERE score == 1\" --json", "nature": "json" }

# Osqueryd
{"osquerydFileEvents": "grep -E \"file_events.*$(date +\\\"%b %d\\\")\" /var/log/osquery/osqueryd.results.log | sed -e 's/$/,/' | paste -sd '' - | sed 's/\\(.*\\),/\\1/' | sed 's/^/[/' | sed 's/$/]/'", "nature": "json"}

# Steampipe
{ "steampipeListDoFirewalls": "pkgx steampipe query \"SELECT status,  count(d.*) as Firewalls from  digitalocean_firewall as d group by  status\" --output json", "nature": "json" }
{ "steampipeListDoFirewallInboundRules": "pkgx steampipe query \"SELECT ru.id, ru.title, ru.category, ru.from_id, ru.to_id FROM ( with rules as ( select urn, title, id, i ->> 'protocol' as protocol_number, cidr as cidr_block, i ->> 'ports' as ports, case   when i ->> 'protocol' = 'icmp'   and i ->> 'ports' = '0' then 'All ICMP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' = '0' then 'All TCP'   when i ->> 'protocol' = 'udp'   and i ->> 'ports' = '0' then 'All UDP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/TCP')   when i ->> 'protocol' = 'udp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/UDP')   else concat('Procotol: ', i ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(inbound_rules) as i, jsonb_array_elements_text(i -> 'sources' -> 'addresses') as cidr union select urn, title, id, i ->> 'protocol' as protocol_number, cidr as cidr_block, i ->> 'ports' as ports, case   when i ->> 'protocol' = 'icmp'   and i ->> 'ports' = '0' then 'All ICMP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' = '0' then 'All TCP'   when i ->> 'protocol' = 'udp'   and i ->> 'ports' = '0' then 'All UDP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/TCP')   when i ->> 'protocol' = 'udp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/UDP')   else concat('Procotol: ', i ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(inbound_rules) as i, jsonb_array_elements_text(i -> 'sources' -> 'droplet_ids') as cidr union select urn, title, id, i ->> 'protocol' as protocol_number, cidr as cidr_block, i ->> 'ports' as ports, case   when i ->> 'protocol' = 'icmp'   and i ->> 'ports' = '0' then 'All ICMP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' = '0' then 'All TCP'   when i ->> 'protocol' = 'udp'   and i ->> 'ports' = '0' then 'All UDP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/TCP')   when i ->> 'protocol' = 'udp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/UDP')   else concat('Procotol: ', i ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(inbound_rules) as i, jsonb_array_elements_text(i -> 'sources' -> 'kubernetes_ids') as cidr union select urn, title, id, i ->> 'protocol' as protocol_number, cidr as cidr_block, i ->> 'ports' as ports, case   when i ->> 'protocol' = 'icmp'   and i ->> 'ports' = '0' then 'All ICMP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' = '0' then 'All TCP'   when i ->> 'protocol' = 'udp'   and i ->> 'ports' = '0' then 'All UDP'   when i ->> 'protocol' = 'tcp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/TCP')   when i ->> 'protocol' = 'udp'   and i ->> 'ports' <> '0' then concat(i ->> 'ports', '/UDP')   else concat('Procotol: ', i ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(inbound_rules) as i, jsonb_array_elements_text(i -> 'sources' -> 'load_balancer_uids') as cidr) select distinct cidr_block as id, cidr_block as title, 'cidr_block' as category, null as from_id, null as to_id from rules union select concat(title, '_', rule_description) as id, rule_description as title, 'rule' as category, null as from_id, null as to_id from rules union select distinct title as id, title as title, 'inbound' as category, null as from_id, null as to_id from rules union select null as id, null as title, protocol_number as category, cidr_block as from_id, concat(title, '_', rule_description) as to_id from rules union select null as id, null as title, protocol_number as category, concat(title, '_', rule_description) as from_id, title as to_id from rules ) ru\" --output json", "nature": "json" }
{ "steampipeListDoFirewallOutboundRules":"pkgx steampipe query \"SELECT ru.id, ru.title, ru.category, ru.from_id, ru.to_id FROM (with rules as ( select urn, title, id, r ->> 'protocol' as protocol_number, cidr as cidr_block, r ->> 'ports' as ports, case   when r ->> 'protocol' = 'icmp'   and r ->> 'ports' = '0' then 'All ICMP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' = '0' then 'All TCP'   when r ->> 'protocol' = 'udp' and r ->> 'ports' = '0' then 'All UDP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/TCP')   when r ->> 'protocol' = 'udp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/UDP')   else concat('Procotol: ', r ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(outbound_rules) as r, jsonb_array_elements_text(r -> 'destinations' -> 'addresses') as cidr union select urn, title, id, r ->> 'protocol' as protocol_number, cidr as cidr_block, r ->> 'ports' as ports, case   when r ->> 'protocol' = 'icmp'   and r ->> 'ports' = '0' then 'All ICMP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' = '0' then 'All TCP'   when r ->> 'protocol' = 'udp' and r ->> 'ports' = '0' then 'All UDP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/TCP')   when r ->> 'protocol' = 'udp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/UDP')   else concat('Procotol: ', r ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(outbound_rules) as r, jsonb_array_elements_text(r -> 'destinations' -> 'droplet_ids') as cidr union select urn, title, id, r ->> 'protocol' as protocol_number, cidr as cidr_block, r ->> 'ports' as ports, case   when r ->> 'protocol' = 'icmp'   and r ->> 'ports' = '0' then 'All ICMP'   when r ->> 'protocol' = 'tcp' and r ->> 'ports' = '0' then 'All TCP'   when r ->> 'protocol' = 'udp'   and r ->> 'ports' = '0' then 'All UDP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/TCP')   when r ->> 'protocol' = 'udp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/UDP')   else concat('Procotol: ', r ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(outbound_rules) as r, jsonb_array_elements_text(r -> 'destinations' -> 'kubernetes_ids') as cidr union select urn, title, id, r ->> 'protocol' as protocol_number, cidr as cidr_block, r ->> 'ports' as ports, case   when r ->> 'protocol' = 'icmp'   and r ->> 'ports' = '0' then 'All ICMP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' = '0' then 'All TCP'   when r ->> 'protocol' = 'udp'   and r ->> 'ports' = '0' then 'All UDP'   when r ->> 'protocol' = 'tcp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/TCP')   when r ->> 'protocol' = 'udp'   and r ->> 'ports' <> '0' then concat(r ->> 'ports', '/UDP') else concat('Procotol: ', r ->> 'protocol') end as rule_description from digitalocean_firewall, jsonb_array_elements(outbound_rules) as r, jsonb_array_elements_text(r -> 'destinations' -> 'load_balancer_uids') as cidr) select distinct title as id, title as title, 'inbound' as category, null as from_id, null as to_id, 0 as depth from rules union select concat(title, '_', rule_description) as id, rule_description as title, 'rule' as category, null as from_id, null as to_id, 1 as depth from rules union select distinct cidr_block as id, cidr_block as title, 'cidr_block' as category, null as from_id, null as to_id, 2 as depth from rules union select null as id, null as title, protocol_number as category, concat(title, '_', rule_description) as from_id, title as to_id, null as depth from rules union select null as id, null as title, protocol_number as category, cidr_block as from_id, concat(title, '_', rule_description) as from_id, null as depth from rules) ru\" --output json", "nature": "json" }

# cnquery
{"cnqueryListAllPorts": "pkgx cnquery run -c \"ports.listening { port process }\" --json", "nature": "json"}

# cnquery-packs
{ "CnquerypacksAwsInventory": "pkgx cnquery scan aws -f $HOME/cnquery-packs/core/mondoo-aws-inventory.mql.yaml  --json", "nature": "json" }
{ "CnquerypacksLinuxIncident": "pkgx cnquery scan -f $HOME/cnquery-packs/core/mondoo-linux-incident-response.mql.yaml  --json", "nature": "json" }
{ "CnquerypacksLinuxInventory": "pkgx cnquery scan -f $HOME/cnquery-packs/core/mondoo-linux-inventory.mql.yaml  --json", "nature": "json" }
{ "CnquerypacksOpensslIncidentResponse": "pkgx cnquery scan -f $HOME/cnquery-packs/core/mondoo-openssl-incident-response.mql.yaml  --json", "nature": "json" }
{ "CnquerypacksSslTlsCertificateIncidentResponse": "pkgx cnquery scan host medigy.com -f $HOME/cnquery-packs/core/mondoo-ssl-tls-certificate-incident-response.mql.yaml --json", "nature": "json" }

# Authlog
# {"authLogInfo": "grep \"$(date +\\\"%b %d\\\")\" /var/log/auth.log | jq -R -s -c 'split(\"\\n\") | .[:-1] | map(split(\" \") | {date: \"\\(.[0]) \\(.[1]) \\(.[2])\", message: \"\\(.[5:] | join(\" \"))\"})'", "nature": "json"}

# Asymmetric Cryptography
{ "AsymmetricCryptography": "osqueryi \"SELECT * FROM file WHERE (path LIKE '/home/%/.ssh/%.pub' OR path LIKE '/home/%/.ssh/authorized_keys')\" --json","nature": "json" }
