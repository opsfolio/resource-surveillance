# `surveilr` Resource Surveillance

This Rust-based project is an extendable file system inspector for performing
surveillance of machine resources. It is used to walk resources like file
systems and generate an SQLite database which can then be consumed by any
computing environment that supports SQLite.

## Installation

You can install the latest `surveilr` using either of the following one-liners:

```bash
$ curl -sL https://raw.githubusercontent.com/opsfolio/resource-surveillance/main/install.sh | sh

# if you want a different install path
$ SURVEILR_HOME="$HOME/bin" curl -sL https://raw.githubusercontent.com/opsfolio/resource-surveillance/main/install.sh | sh
```

If you use `eget`:

```bash
$ eget opsfolio/resource-surveillance --asset tar.gz
```

## Usage

```bash
$ ./surveilr --help                         # get CLI help
$ ./surveilr fs-walk                        # walk the current working directory (CWD) with debug messages
$ ./surveilr fs-walk -r /other -r /other2   # walk some other director(ies)
$ ./surveilr --completions fish | source    # setup completions to reduce typing
```

## Command-Line Help for `surveilr`

This document contains the help content for the `surveilr` command-line program
and is autogenerated by running `--help-markdown`.

**Command Overview:**

- [`surveilr` Resource Surveillance](#surveilr-resource-surveillance)
  - [Installation](#installation)
  - [Usage](#usage)
  - [Command-Line Help for `surveilr`](#command-line-help-for-surveilr)
  - [`surveilr`](#surveilr)
          - [**Subcommands:**](#subcommands)
          - [**Options:**](#options)
  - [`surveilr cat-cells`](#surveilr-cat-cells)
          - [**Options:**](#options-1)
  - [`surveilr notebooks`](#surveilr-notebooks)
          - [**Options:**](#options-2)
  - [`surveilr fs-walk`](#surveilr-fs-walk)
          - [**Options:**](#options-3)
  - [Development](#development)

## `surveilr`

**Usage:** `surveilr [OPTIONS] [COMMAND]`

###### **Subcommands:**

- `cat-cells` — Notebooks' cells emit utilities
- `notebooks` — Notebooks maintenance utilities
- `fs-walk` — Walks the device file system

###### **Options:**

- `--help-markdown` — Generate a Markdown file of all CLI commands and options
- `--device-name <DEVICE_NAME>` — How to identify this device

  Default value: `Titan`
- `-c`, `--config <FILE>` — TODO: Use a Deno *.ts or Nickel config file for
  defaults, allowing CLI args as overrides
- `-d`, `--debug` — TODO: Turn debugging information on

## `surveilr cat-cells`

Notebooks' cells emit utilities

**Usage:** `surveilr cat-cells [OPTIONS]`

###### **Options:**

- `-d`, `--db-fs-path <DB_FS_PATH>` — target SQLite database

  Default value: `./resource-surveillance.sqlite.db`
- `-n`, `--notebook <NOTEBOOK>`
- `-c`, `--cell <CELL>`

## `surveilr notebooks`

Notebooks maintenance utilities

**Usage:** `surveilr notebooks [OPTIONS]`

###### **Options:**

- `-d`, `--db-fs-path <DB_FS_PATH>` — target SQLite database

  Default value: `./resource-surveillance.sqlite.db`

## `surveilr fs-walk`

Walks the device file system

**Usage:** `surveilr fs-walk [OPTIONS]`

###### **Options:**

- `-r`, `--root-path <ROOT_PATH>` — one or more root paths to walk

  Default value: `.`
- `-i`, `--ignore-entry <IGNORE_ENTRY>` — reg-exes to use to ignore files in
  root-path(s)

  Default value: `/(\.git|node_modules)/`
- `--compute-digests <COMPUTE_DIGESTS>` — reg-exes to use to compute digests for

  Default value: `.*`
- `--surveil-content <SURVEIL_CONTENT>` — reg-exes to use to load content for
  entry instead of just walking

  Default value: `\.(md|mdx|html|json)$`
- `--surveil-db-fs-path <SURVEIL_DB_FS_PATH>` — target SQLite database

  Default value: `./resource-surveillance.sqlite.db`

## Development

![Architecture](architecture.drawio.svg)

**IMPORTANT**: Use SQLa to generate all SQL so it's portable but use Rusqlite to
make working with SQLite more ergonomic. Remember to only use libraries to help
improve developer productivity, always assume SQLite database will be used
across polyglot programming environments so SQL code should be transparent and
portable.

Development prerequisites:

- Install Rust toolchain (1.73 or above, best to use `rustup`, `asdf` or `rtx`
  for multiple simultaneous versions)
- `cargo install just` so we can use `Justfile` for task management

Regular use:

```bash
$ just --completions fish | source            # setup completions to reduce typing

$ just test                                   # run unit tests with cargo nextest

$ just run                                    # get CLI help
$ cargo run -- --help                         # get CLI help, same as above

$ just run help-markdown                      # get CLI in Markdown and update this README.md manually
$ cargo run -- --help-markdown > CLI-help.md  # get CLI in Markdown, same as above

$ just run fs-walk --help                     # get CLI help for fs-walk subcommand
$ just run --debug fs-walk                    # walk the current working directory (CWD) with debug messages
$ just run fs-walk -r /other -r /other2       # walk some other director(ies)
$ just run fs-walk -i .git/                   # walk CWD, ignore .git/ paths
$ just run fs-walk -i .git/ -i target/        # walk CWD, ignore .git/ and target/ paths

$ just sqla-sync                              # generate SQLa bootstrap and other SQL
                                             
$ just dev                                    # turn on auto-compile, auto-run during development
                                              # using cargo-watch command
```
